version: '2.3'

services:
    prometheus:
        build: prometheus
        ports:
            - 9090:9090
        networks:
            - default
        volumes:
            - ./prometheus/:/etc/prometheus/
            - prometheus_data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/usr/share/prometheus/console_libraries'
            - '--web.console.templates=/usr/share/prometheus/consoles'

    node_exporter:
        image: prom/node-exporter
        command: --collector.textfile.directory=/run/prometheus
        pid: "host"
        volumes:
            - prometheus_data:/prometheus
            - prometheus_textfiles:/run/prometheus:ro
        ports:
            - 9100:9100
        networks:
            - default

    grafana:
        image: grafana/grafana
        volumes:
            - grafana_data:/var/lib/grafana
        ports:
            - 3000:3000
        networks:
            - default

    dcgm_exporter:
        image: nvidia/dcgm-exporter:1.4.3
        runtime: nvidia
        volumes:
            - prometheus_textfiles:/run/prometheus
        networks:
            - default

volumes:
    prometheus_textfiles:
        driver_opts:
            type: tmpfs
            device: tmpfs
    prometheus_data:
        driver: local
    grafana_data:
        driver: local

networks:
    default:
        driver: bridge
